<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bachelor Room Expense Manager Pro</title>
    <style>
        /* Enhanced styling for professional UI */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-tab.active {
            color: #4facfe;
            background: white;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }
        
        .nav-tab:hover {
            color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #4facfe;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, button {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }
        
        button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 10px 25px rgba(253, 116, 108, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 10px 25px rgba(86, 171, 47, 0.4);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 20px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .member-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #4facfe;
        }
        
        .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            font-weight: bold;
            overflow: hidden;
            position: relative;
        }
        
        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .member-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        .summary-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 4px solid #4facfe;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .summary-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .balance-item:last-child {
            border-bottom: none;
        }
        
        .amount-positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .amount-negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #f5c6cb;
        }
        
        .date-filter {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .date-filter .form-group {
            margin-bottom: 0;
            min-width: 150px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #4facfe;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-label:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: #00f2fe;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .month-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .month-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-color: #4facfe;
        }
        
        .month-btn:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state img {
            width: 120px;
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .calculator-display {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 25px;
        }
        
        .calculator-items {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
        }
        
        .calculator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .calculator-item:last-child {
            margin-bottom: 0;
        }
        
        .calculator-total {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: #333;
        }
        
        .item-amount {
            color: #4facfe;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .remove-item:hover {
            background: #c82333;
        }
        
        .settlement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            margin-bottom: 15px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .settlement-item:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
        }
        
        .settlement-item.paid {
            background: #f8f9fa;
            border-color: #28a745;
            opacity: 0.8;
        }
        
        .settlement-details {
            flex: 1;
        }
        
        .settlement-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .settlement-parties {
            color: #666;
            font-size: 0.95em;
        }
        
        .settlement-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .settlement-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-paid {
            background: #d4edda;
            color: #155724;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                min-width: auto;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            .date-filter {
                flex-direction: column;
            }
            
            .month-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Bachelor Room Manager Pro</h1>
            <p>Advanced expense tracking with smart analytics</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('members')">üë• Members</button>
            <button class="nav-tab" onclick="switchTab('expenses')">üí∞ Add Expense</button>
            <button class="nav-tab" onclick="switchTab('calculator')">üßÆ Calculator</button>
            <button class="nav-tab" onclick="switchTab('settlements')">üí≥ Settlements</button>
            <button class="nav-tab" onclick="switchTab('history')">üìã History</button>
            <button class="nav-tab" onclick="switchTab('analytics')">üìà Analytics</button>
        </div>
        
        <!-- Error Display -->
        <div id="errorContainer" class="error" style="display: none;"></div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-number" id="totalExpensesCount">0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalAmount">‚Çπ0</div>
                    <div class="stat-label">Total Amount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisMonthAmount">‚Çπ0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgExpense">‚Çπ0</div>
                    <div class="stat-label">Avg per Person</div>
                </div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>‚öñÔ∏è Current Balances</h3>
                    <div id="dashboardBalances">
                        <div class="loading">Loading balances...</div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üîÑ Quick Settlements</h3>
                    <div id="dashboardSettlements">
                        <div class="loading">Calculating settlements...</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üìÖ Recent Expenses</h2>
                <div id="recentExpenses">
                    <div class="loading">Loading recent expenses...</div>
                </div>
            </div>
        </div>
        
        <!-- Members Tab -->
        <div id="members" class="tab-content">
            <div class="section">
                <h2>üë• Manage Group Members</h2>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="memberName">Member Name:</label>
                            <input type="text" id="memberName" placeholder="Enter member name">
                        </div>
                        <div class="form-group">
                            <label for="memberPhoto">Profile Picture:</label>
                            <div class="file-upload">
                                <input type="file" id="memberPhoto" accept="image/*">
                                <label for="memberPhoto" class="file-upload-label">
                                    üì∑ Choose Photo (Optional)
                                </label>
                            </div>
                        </div>
                        <button onclick="addMember()" id="addMemberBtn">Add Member</button>
                    </div>
                </div>
                
                <div class="members-grid" id="membersGrid">
                    <div class="loading">Loading members...</div>
                </div>
            </div>
        </div>
        
        <!-- Add Expense Tab -->
        <div id="expenses" class="tab-content">
            <div class="section">
                <h2>üí∞ Add New Expense</h2>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="expenseAmount">Amount (‚Çπ):</label>
                            <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="expenseDescription">Description:</label>
                            <input type="text" id="expenseDescription" placeholder="What was purchased?">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="expenseDate">Date:</label>
                            <input type="date" id="expenseDate">
                        </div>
                        <div class="form-group">
                            <label for="expensePaidBy">Paid By:</label>
                            <select id="expensePaidBy">
                                <option value="">Select who paid</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button onclick="addExpense()" id="addExpenseBtn" class="btn-secondary">Add Expense</button>
            </div>
        </div>
        
        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content">
            <div class="section">
                <h2>üßÆ Expense Calculator</h2>
                <p style="color: #666; margin-bottom: 25px;">Add multiple items for the same date and person, then save as one expense.</p>
                
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="calcDate">Date:</label>
                            <input type="date" id="calcDate">
                        </div>
                        <div class="form-group">
                            <label for="calcPaidBy">Paid By:</label>
                            <select id="calcPaidBy">
                                <option value="">Select who paid</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="itemDescription">Item Description:</label>
                            <input type="text" id="itemDescription" placeholder="What item was bought?">
                        </div>
                        <div class="form-group">
                            <label for="itemAmount">Item Amount (‚Çπ):</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="itemAmount" placeholder="0.00" step="0.01" min="0" style="flex: 1;">
                                <button onclick="addItemToCalculator()" class="btn-success" style="width: auto; padding: 15px 20px;">Add Item</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calculator Display -->
                <div class="calculator-display">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìù Items List</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="clearCalculator()" class="btn-secondary" style="width: auto; padding: 10px 15px;">Clear All</button>
                            <div class="calculator-total">
                                Total: ‚Çπ<span id="calculatorTotal">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="calculatorItems" class="calculator-items">
                        <div class="empty-state">
                            <div style="font-size: 3em;">üõí</div>
                            <p>No items added yet. Start adding items to calculate total.</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button onclick="saveCalculatorExpense()" id="saveCalculatorBtn" class="btn-success" style="width: 100%;">
                            üíæ Save as Single Expense
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settlements Tab -->
        <div id="settlements" class="tab-content">
            <div class="section">
                <h2>üí≥ Settlement Tracking</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <p style="color: #666;">Track who has paid their share and manage settlements</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="recalculateSettlements()" class="btn-secondary" style="width: auto; padding: 12px 20px;">
                            üîÑ Recalculate
                        </button>
                        <button onclick="markAllPaid()" class="btn-success" style="width: auto; padding: 12px 20px;">
                            ‚úÖ Mark All as Paid
                        </button>
                    </div>
                </div>
                
                <div id="settlementsList">
                    <div class="loading">Loading settlements...</div>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="section">
                <h2>üìã Expense History</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; flex: 1;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label for="endDate">To Date:</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label for="memberFilter">Filter by Member:</label>
                            <select id="memberFilter">
                                <option value="">All Members</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>&nbsp;</label>
                            <button onclick="filterExpenses()" class="btn-success">Apply Filter</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>&nbsp;</label>
                        <button onclick="downloadExpensesCSV()" class="btn-secondary" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                            üì• Download CSV
                        </button>
                    </div>
                </div>
                
                <div id="expensesLoading" class="loading">Loading expenses...</div>
                <table id="expensesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Paid By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="section">
                <h2>üìà Monthly Analytics</h2>
                <div class="month-selector" id="monthSelector">
                    <!-- Month buttons will be generated here -->
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>üìä Monthly Breakdown</h3>
                        <div id="monthlyStats">
                            <div class="loading">Loading monthly data...</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h3>üëë Top Spenders</h3>
                        <div id="topSpenders">
                            <div class="loading">Calculating spenders...</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h3>üè∑Ô∏è Expense Categories</h3>
                        <div id="expenseCategories">
                            <div class="loading">Analyzing categories...</div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h3>üí≥ Settlement Summary</h3>
                        <div id="analyticsSettlements">
                            <div class="loading">Processing settlements...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCzjEmhF7N6CSaGMUhfPY9OQkgHsYpAt58",
            authDomain: "room-33cdd.firebaseapp.com",
            projectId: "room-33cdd",
            storageBucket: "room-33cdd.firebasestorage.app",
            messagingSenderId: "99910992330",
            appId: "1:99910992330:web:cebfa93d307d05c9f28f33",
            measurementId: "G-6JTKCD6S4J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables
        let members = [];
        let expenses = [];
        let filteredExpenses = [];
        let currentTab = 'dashboard';
        let selectedMonth = new Date().getMonth();
        let selectedYear = new Date().getFullYear();
        let calculatorItems = [];
        let settlements = [];

        // Make functions available globally
        window.switchTab = switchTab;
        window.addMember = addMember;
        window.removeMember = removeMember;
        window.addExpense = addExpense;
        window.deleteExpense = deleteExpense;
        window.filterExpenses = filterExpenses;
        window.selectMonth = selectMonth;
        window.addItemToCalculator = addItemToCalculator;
        window.removeItemFromCalculator = removeItemFromCalculator;
        window.clearCalculator = clearCalculator;
        window.saveCalculatorExpense = saveCalculatorExpense;
        window.downloadExpensesCSV = downloadExpensesCSV;
        window.markSettlementPaid = markSettlementPaid;
        window.markAllPaid = markAllPaid;
        window.recalculateSettlements = recalculateSettlements;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.getElementById('calcDate').valueAsDate = new Date();
            document.getElementById('startDate').valueAsDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            document.getElementById('endDate').valueAsDate = new Date();
            
            generateMonthSelector();
            loadMembers();
            loadExpenses();
            loadSettlements();
        });

        /**
         * Tab switching functionality
         */
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            
            // Load data based on active tab
            if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'settlements') {
                loadSettlements();
            }
        }

        /**
         * Error handling utility
         */
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
            
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }

        /**
         * Show success message helper
         */
        function showSuccessMessage(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.background = '#d4edda';
            errorContainer.style.color = '#155724';
            errorContainer.style.borderColor = '#c3e6cb';
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
            
            setTimeout(() => {
                errorContainer.style.display = 'none';
                errorContainer.style.background = '#f8d7da';
                errorContainer.style.color = '#721c24';
                errorContainer.style.borderColor = '#f5c6cb';
            }, 3000);
        }

        /**
         * Add a new member with optional profile picture
         */
        async function addMember() {
            const memberNameInput = document.getElementById('memberName');
            const memberPhotoInput = document.getElementById('memberPhoto');
            const memberName = memberNameInput.value.trim();
            
            if (!memberName) {
                showError('Please enter a member name');
                return;
            }
            
            if (members.some(member => member.name.toLowerCase() === memberName.toLowerCase())) {
                showError('Member already exists');
                return;
            }
            
            const addBtn = document.getElementById('addMemberBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            
            try {
                let photoURL = null;
                
                // Upload photo if provided
                if (memberPhotoInput.files[0]) {
                    const file = memberPhotoInput.files[0];
                    const photoRef = ref(storage, `member-photos/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(photoRef, file);
                    photoURL = await getDownloadURL(snapshot.ref);
                }
                
                // Add member to Firestore
                await addDoc(collection(db, 'members'), {
                    name: memberName,
                    photoURL: photoURL,
                    createdAt: new Date()
                });
                
                // Clear inputs
                memberNameInput.value = '';
                memberPhotoInput.value = '';
                
                await loadMembers();
                recalculateSettlements(); // Recalculate when members change
            } catch (error) {
                console.error('Error adding member:', error);
                showError('Failed to add member. Please try again.');
            }
            
            addBtn.disabled = false;
            addBtn.textContent = 'Add Member';
        }

        /**
         * Remove a member from the group
         */
        async function removeMember(memberId, memberName) {
            if (!confirm(`Are you sure you want to remove ${memberName}? This will also remove all their expenses.`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'members', memberId));
                
                const expensesQuery = query(collection(db, 'expenses'), where('paidBy', '==', memberName));
                const expensesSnapshot = await getDocs(expensesQuery);
                
                const deletePromises = expensesSnapshot.docs.map(docSnapshot => 
                    deleteDoc(doc(db, 'expenses', docSnapshot.id))
                );
                
                await Promise.all(deletePromises);
                
                await loadMembers();
                await loadExpenses();
                recalculateSettlements(); // Recalculate when members change
            } catch (error) {
                console.error('Error removing member:', error);
                showError('Failed to remove member. Please try again.');
            }
        }

        /**
         * Load members from Firestore and update UI
         */
        async function loadMembers() {
            try {
                const membersQuery = query(collection(db, 'members'), orderBy('name'));
                const snapshot = await getDocs(membersQuery);
                members = [];
                
                snapshot.forEach(docSnapshot => {
                    members.push({
                        id: docSnapshot.id,
                        ...docSnapshot.data()
                    });
                });
                
                updateMembersUI();
                updatePaidByOptions();
                updateMemberFilter();
            } catch (error) {
                console.error('Error loading members:', error);
                showError('Failed to load members');
            }
        }

        /**
         * Update the members grid UI
         */
        function updateMembersUI() {
            const membersGrid = document.getElementById('membersGrid');
            
            if (members.length === 0) {
                membersGrid.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4em;">üë•</div>
                        <p>No members added yet. Add some members to get started!</p>
                    </div>
                `;
                return;
            }
            
            membersGrid.innerHTML = members.map(member => `
                <div class="member-card">
                    <div class="member-avatar">
                        ${member.photoURL ? 
                            `<img src="${member.photoURL}" alt="${member.name}">` : 
                            member.name.charAt(0).toUpperCase()
                        }
                    </div>
                    <div class="member-name">${member.name}</div>
                    <div class="member-actions">
                        <button class="btn-small btn-secondary" onclick="removeMember('${member.id}', '${member.name}')">
                            Remove
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update the "Paid By" dropdown options
         */
        function updatePaidByOptions() {
            const paidBySelect = document.getElementById('expensePaidBy');
            const calcPaidBySelect = document.getElementById('calcPaidBy');
            
            paidBySelect.innerHTML = '<option value="">Select who paid</option>';
            calcPaidBySelect.innerHTML = '<option value="">Select who paid</option>';
            
            members.forEach(member => {
                const option1 = document.createElement('option');
                option1.value = member.name;
                option1.textContent = member.name;
                paidBySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = member.name;
                option2.textContent = member.name;
                calcPaidBySelect.appendChild(option2);
            });
        }

        /**
         * Update member filter dropdown
         */
        function updateMemberFilter() {
            const memberFilter = document.getElementById('memberFilter');
            memberFilter.innerHTML = '<option value="">All Members</option>';
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                memberFilter.appendChild(option);
            });
        }

        /**
         * Add a new expense
         */
        async function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value.trim();
            const date = document.getElementById('expenseDate').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            if (!description) {
                showError('Please enter a description');
                return;
            }
            
            if (!date) {
                showError('Please select a date');
                return;
            }
            
            if (!paidBy) {
                showError('Please select who paid');
                return;
            }
            
            const addBtn = document.getElementById('addExpenseBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            
            try {
                await addDoc(collection(db, 'expenses'), {
                    amount: amount,
                    description: description,
                    date: date,
                    paidBy: paidBy,
                    createdAt: new Date()
                });
                
                // Clear form
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expenseDate').valueAsDate = new Date();
                document.getElementById('expensePaidBy').value = '';
                
                await loadExpenses();
                recalculateSettlements(); // Recalculate when expenses change
                
                // Switch to dashboard to show updated stats
                switchTab('dashboard');
            } catch (error) {
                console.error('Error adding expense:', error);
                showError('Failed to add expense. Please try again.');
            }
            
            addBtn.disabled = false;
            addBtn.textContent = 'Add Expense';
        }

        /**
         * Delete an expense
         */
        async function deleteExpense(expenseId, description) {
            if (!confirm(`Are you sure you want to delete the expense: "${description}"?`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'expenses', expenseId));
                await loadExpenses();
                recalculateSettlements(); // Recalculate when expenses change
                
                showSuccessMessage('Expense deleted successfully!');
            } catch (error) {
                console.error('Error deleting expense:', error);
                showError('Failed to delete expense. Please try again.');
            }
        }

        /**
         * Load expenses from Firestore
         */
        async function loadExpenses() {
            try {
                const expensesQuery = query(collection(db, 'expenses'), orderBy('date', 'desc'));
                const snapshot = await getDocs(expensesQuery);
                expenses = [];
                
                snapshot.forEach(docSnapshot => {
                    expenses.push({
                        id: docSnapshot.id,
                        ...docSnapshot.data()
                    });
                });
                
                filteredExpenses = [...expenses];
                updateExpensesTable();
                updateDashboard();
                updateAnalytics();
            } catch (error) {
                console.error('Error loading expenses:', error);
                showError('Failed to load expenses');
            }
        }

        /**
         * Filter expenses based on date range and member
         */
        function filterExpenses() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const memberFilter = document.getElementById('memberFilter').value;
            
            filteredExpenses = expenses.filter(expense => {
                const expenseDate = expense.date;
                const dateMatch = (!startDate || expenseDate >= startDate) && 
                                 (!endDate || expenseDate <= endDate);
                const memberMatch = !memberFilter || expense.paidBy === memberFilter;
                
                return dateMatch && memberMatch;
            });
            
            updateExpensesTable();
        }

        /**
         * Update the expenses table
         */
        function updateExpensesTable() {
            const loadingDiv = document.getElementById('expensesLoading');
            const expensesTable = document.getElementById('expensesTable');
            const tbody = document.getElementById('expensesTableBody');
            
            loadingDiv.style.display = 'none';
            expensesTable.style.display = 'table';
            
            if (filteredExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666; font-style: italic; padding: 40px;">No expenses found for the selected criteria</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredExpenses.map(expense => `
                <tr>
                    <td>${new Date(expense.date).toLocaleDateString('en-IN')}</td>
                    <td>${expense.description}</td>
                    <td>‚Çπ${expense.amount.toFixed(2)}</td>
                    <td>${expense.paidBy}</td>
                    <td>
                        <button class="btn-small btn-secondary" 
                                onclick="deleteExpense('${expense.id}', '${expense.description.replace(/'/g, '\\\'')}')"
                                style="padding: 6px 12px; font-size: 11px; width: auto;">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Calculator functions
         */
        function addItemToCalculator() {
            const itemDescription = document.getElementById('itemDescription').value.trim();
            const itemAmount = parseFloat(document.getElementById('itemAmount').value);
            
            if (!itemDescription) {
                showError('Please enter item description');
                return;
            }
            
            if (!itemAmount || itemAmount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            const item = {
                id: Date.now(),
                description: itemDescription,
                amount: itemAmount
            };
            
            calculatorItems.push(item);
            
            // Clear inputs
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemAmount').value = '';
            
            updateCalculatorDisplay();
        }

        function removeItemFromCalculator(itemId) {
            calculatorItems = calculatorItems.filter(item => item.id !== itemId);
            updateCalculatorDisplay();
        }

        function clearCalculator() {
            if (calculatorItems.length === 0) return;
            
            if (confirm('Are you sure you want to clear all items?')) {
                calculatorItems = [];
                updateCalculatorDisplay();
            }
        }

        function updateCalculatorDisplay() {
            const calculatorItemsDiv = document.getElementById('calculatorItems');
            const calculatorTotal = document.getElementById('calculatorTotal');
            
            if (calculatorItems.length === 0) {
                calculatorItemsDiv.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em;">üõí</div>
                        <p>No items added yet. Start adding items to calculate total.</p>
                    </div>
                `;
                calculatorTotal.textContent = '0.00';
                return;
            }
            
            const total = calculatorItems.reduce((sum, item) => sum + item.amount, 0);
            calculatorTotal.textContent = total.toFixed(2);
            
            calculatorItemsDiv.innerHTML = calculatorItems.map(item => `
                <div class="calculator-item">
                    <div class="item-details">
                        <div class="item-name">${item.description}</div>
                    </div>
                    <div class="item-amount">‚Çπ${item.amount.toFixed(2)}</div>
                    <button class="remove-item" onclick="removeItemFromCalculator(${item.id})">√ó</button>
                </div>
            `).join('');
        }

        async function saveCalculatorExpense() {
            if (calculatorItems.length === 0) {
                showError('Please add some items first');
                return;
            }
            
            const date = document.getElementById('calcDate').value;
            const paidBy = document.getElementById('calcPaidBy').value;
            
            if (!date) {
                showError('Please select a date');
                return;
            }
            
            if (!paidBy) {
                showError('Please select who paid');
                return;
            }
            
            const total = calculatorItems.reduce((sum, item) => sum + item.amount, 0);
            const description = `Multiple items: ${calculatorItems.map(item => item.description).join(', ')}`;
            
            const saveBtn = document.getElementById('saveCalculatorBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                await addDoc(collection(db, 'expenses'), {
                    amount: total,
                    description: description,
                    date: date,
                    paidBy: paidBy,
                    items: calculatorItems,
                    createdAt: new Date()
                });
                
                // Clear calculator
                calculatorItems = [];
                document.getElementById('calcDate').valueAsDate = new Date();
                document.getElementById('calcPaidBy').value = '';
                updateCalculatorDisplay();
                
                await loadExpenses();
                recalculateSettlements();
                
                showSuccessMessage('Calculator expense saved successfully!');
                switchTab('dashboard');
            } catch (error) {
                console.error('Error saving calculator expense:', error);
                showError('Failed to save expense. Please try again.');
            }
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Save as Single Expense';
        }

        /**
         * Settlement Management Functions
         */
        function loadSettlements() {
            const storedSettlements = localStorage.getItem('settlements');
            settlements = storedSettlements ? JSON.parse(storedSettlements) : [];
            
            // If no stored settlements, calculate from current balances
            if (settlements.length === 0 && expenses.length > 0) {
                calculateCurrentSettlements();
            }
            
            updateSettlementsList();
        }

        function calculateCurrentSettlements() {
            if (members.length === 0 || expenses.length === 0) {
                settlements = [];
                localStorage.setItem('settlements', JSON.stringify(settlements));
                return;
            }
            
            const totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const perPersonShare = totalAmount / members.length;
            const balances = {};
            
            // Calculate balances
            members.forEach(member => {
                balances[member.name] = -perPersonShare;
            });
            
            expenses.forEach(expense => {
                if (balances.hasOwnProperty(expense.paidBy)) {
                    balances[expense.paidBy] += expense.amount;
                }
            });
            
            // Calculate settlements
            const currentSettlements = calculateSettlements(balances);
            
            // Store settlements with payment status (preserve existing payment status)
            const existingSettlements = settlements.reduce((acc, s) => {
                acc[`${s.from}-${s.to}`] = s;
                return acc;
            }, {});
            
            settlements = currentSettlements.map((settlement, index) => {
                const key = `${settlement.from}-${settlement.to}`;
                const existing = existingSettlements[key];
                
                return {
                    id: existing ? existing.id : Date.now() + index,
                    from: settlement.from,
                    to: settlement.to,
                    amount: settlement.amount,
                    paid: existing ? existing.paid : false,
                    paidDate: existing ? existing.paidDate : null
                };
            });
            
            localStorage.setItem('settlements', JSON.stringify(settlements));
        }

        function recalculateSettlements() {
            calculateCurrentSettlements();
            updateSettlementsList();
            updateDashboard(); // Refresh dashboard settlements
        }

        function updateSettlementsList() {
            const settlementsListDiv = document.getElementById('settlementsList');
            
            if (!settlementsListDiv) return; // Tab not loaded yet
            
            if (settlements.length === 0) {
                settlementsListDiv.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em;">‚úÖ</div>
                        <p>All settled! No outstanding payments.</p>
                    </div>
                `;
                return;
            }
            
            settlementsListDiv.innerHTML = settlements.map(settlement => `
                <div class="settlement-item ${settlement.paid ? 'paid' : ''}">
                    <div class="settlement-details">
                        <div class="settlement-amount">‚Çπ${settlement.amount.toFixed(2)}</div>
                        <div class="settlement-parties">${settlement.from} ‚Üí ${settlement.to}</div>
                        ${settlement.paid ? `<div style="font-size: 0.8em; color: #28a745;">‚úÖ Paid on ${new Date(settlement.paidDate).toLocaleDateString()}</div>` : ''}
                    </div>
                    <div class="settlement-actions">
                        <span class="settlement-status status-${settlement.paid ? 'paid' : 'pending'}">
                            ${settlement.paid ? 'Paid' : 'Pending'}
                        </span>
                        ${!settlement.paid ? `
                            <button class="btn-small btn-success" onclick="markSettlementPaid(${settlement.id})" style="width: auto; padding: 6px 12px;">
                                ‚úÖ Mark Paid
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function markSettlementPaid(settlementId) {
            const settlement = settlements.find(s => s.id === settlementId);
            if (!settlement || settlement.paid) return;
            
            if (!confirm(`Mark payment from ${settlement.from} to ${settlement.to} as completed?`)) {
                return;
            }
            
            settlement.paid = true;
            settlement.paidDate = new Date().toISOString();
            
            localStorage.setItem('settlements', JSON.stringify(settlements));
            updateSettlementsList();
            updateDashboard(); // Refresh dashboard to show updated settlements
            
            showSuccessMessage(`Payment marked as completed! ‚úÖ`);
        }

        function markAllPaid() {
            const unpaidSettlements = settlements.filter(s => !s.paid);
            
            if (unpaidSettlements.length === 0) {
                showError('No pending settlements to mark as paid.');
                return;
            }
            
            if (!confirm(`Mark all ${unpaidSettlements.length} settlements as paid?`)) {
                return;
            }
            
            settlements.forEach(settlement => {
                if (!settlement.paid) {
                    settlement.paid = true;
                    settlement.paidDate = new Date().toISOString();
                }
            });
            
            localStorage.setItem('settlements', JSON.stringify(settlements));
            updateSettlementsList();
            updateDashboard();
            
            showSuccessMessage(`All settlements marked as paid! üéâ`);
        }

        /**
         * Download expenses as CSV
         */
        function downloadExpensesCSV() {
            if (filteredExpenses.length === 0) {
                showError('No expenses to download. Please add some expenses first.');
                return;
            }
            
            const csvData = [
                ['Date', 'Description', 'Amount (‚Çπ)', 'Paid By', 'Created At']
            ];
            
            filteredExpenses.forEach(expense => {
                const createdDate = expense.createdAt ? 
                    (expense.createdAt.seconds ? 
                        new Date(expense.createdAt.seconds * 1000).toLocaleDateString('en-IN') : 
                        new Date(expense.createdAt).toLocaleDateString('en-IN')
                    ) : 'Unknown';
                
                csvData.push([
                    expense.date,
                    expense.description.replace(/,/g, ';'),
                    expense.amount.toFixed(2),
                    expense.paidBy,
                    createdDate
                ]);
            });
            
            // Add summary data
            csvData.push([]);
            csvData.push(['SUMMARY']);
            csvData.push(['Total Expenses', filteredExpenses.length]);
            csvData.push(['Total Amount', `‚Çπ${filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0).toFixed(2)}`]);
            
            // Add member-wise breakdown
            csvData.push([]);
            csvData.push(['MEMBER-WISE BREAKDOWN']);
            const memberStats = {};
            filteredExpenses.forEach(expense => {
                memberStats[expense.paidBy] = (memberStats[expense.paidBy] || 0) + expense.amount;
            });
            
            Object.entries(memberStats).forEach(([member, amount]) => {
                csvData.push([member, `‚Çπ${amount.toFixed(2)}`]);
            });
            
            // Convert to CSV string
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `expenses_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessMessage('CSV file downloaded successfully!');
        }

        /**
         * Analytics and Dashboard Functions
         */
        function generateMonthSelector() {
            const monthSelector = document.getElementById('monthSelector');
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            monthSelector.innerHTML = months.map((month, index) => `
                <button class="month-btn ${index === currentMonth ? 'active' : ''}" 
                        onclick="selectMonth(${index})">
                    ${month} ${currentYear}
                </button>
            `).join('');
        }

        function selectMonth(monthIndex) {
            selectedMonth = monthIndex;
            
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateAnalytics();
        }

        function updateDashboard() {
            const totalExpenses = expenses.length;
            const totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Calculate this month's expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            const thisMonthAmount = thisMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Calculate average per person
            const avgExpense = members.length > 0 ? totalAmount / members.length : 0;
            
            // Update stats cards
            document.getElementById('totalExpensesCount').textContent = totalExpenses;
            document.getElementById('totalAmount').textContent = `‚Çπ${totalAmount.toFixed(0)}`;
            document.getElementById('thisMonthAmount').textContent = `‚Çπ${thisMonthAmount.toFixed(0)}`;
            document.getElementById('avgExpense').textContent = `‚Çπ${avgExpense.toFixed(0)}`;
            
            // Update balances and settlements
            updateBalancesAndSettlements('dashboard');
            
            // Update recent expenses
            updateRecentExpenses();
        }

        function updateRecentExpenses() {
            const recentExpensesDiv = document.getElementById('recentExpenses');
            const recentExpenses = expenses.slice(0, 5);
            
            if (recentExpenses.length === 0) {
                recentExpensesDiv.innerHTML = '<div class="empty-state"><div style="font-size: 3em;">üìã</div><p>No expenses recorded yet</p></div>';
                return;
            }
            
            recentExpensesDiv.innerHTML = `
                <table style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Paid By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentExpenses.map(expense => `
                            <tr>
                                <td>${new Date(expense.date).toLocaleDateString('en-IN')}</td>
                                <td>${expense.description}</td>
                                <td>‚Çπ${expense.amount.toFixed(2)}</td>
                                <td>${expense.paidBy}</td>
                                <td>
                                    <button class="btn-small btn-secondary" 
                                            onclick="deleteExpense('${expense.id}', '${expense.description.replace(/'/g, '\\\'')}')"
                                            style="padding: 4px 8px; font-size: 10px; width: auto;">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateAnalytics() {
            if (currentTab !== 'analytics') return;
            
            const monthExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === selectedMonth && expenseDate.getFullYear() === selectedYear;
            });
            
            updateMonthlyStats(monthExpenses);
            updateTopSpenders(monthExpenses);
            updateExpenseCategories(monthExpenses);
            updateBalancesAndSettlements('analytics', monthExpenses);
        }

        function updateMonthlyStats(monthExpenses) {
            const monthlyStatsDiv = document.getElementById('monthlyStats');
            const totalAmount = monthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const expenseCount = monthExpenses.length;
            const avgExpense = expenseCount > 0 ? totalAmount / expenseCount : 0;
            
            monthlyStatsDiv.innerHTML = `
                <div class="balance-item">
                    <span>Total Expenses</span>
                    <span class="amount-positive">${expenseCount}</span>
                </div>
                <div class="balance-item">
                    <span>Total Amount</span>
                    <span class="amount-positive">‚Çπ${totalAmount.toFixed(2)}</span>
                </div>
                <div class="balance-item">
                    <span>Average Expense</span>
                    <span>‚Çπ${avgExpense.toFixed(2)}</span>
                </div>
                <div class="balance-item">
                    <span>Per Person Share</span>
                    <span>${members.length > 0 ? `‚Çπ${(totalAmount / members.length).toFixed(2)}` : '‚Çπ0.00'}</span>
                </div>
            `;
        }

        function updateTopSpenders(monthExpenses) {
            const topSpendersDiv = document.getElementById('topSpenders');
            const spenderStats = {};
            
            monthExpenses.forEach(expense => {
                spenderStats[expense.paidBy] = (spenderStats[expense.paidBy] || 0) + expense.amount;
            });
            
            const sortedSpenders = Object.entries(spenderStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedSpenders.length === 0) {
                topSpendersDiv.innerHTML = '<p style="color: #666; font-style: italic;">No expenses this month</p>';
                return;
            }
            
            topSpendersDiv.innerHTML = sortedSpenders.map(([name, amount], index) => `
                <div class="balance-item">
                    <span>${index + 1}. ${name}</span>
                    <span class="amount-positive">‚Çπ${amount.toFixed(2)}</span>
                </div>
            `).join('');
        }

        function updateExpenseCategories(monthExpenses) {
            const categoriesDiv = document.getElementById('expenseCategories');
            const categories = {};
            
            monthExpenses.forEach(expense => {
                const category = categorizeExpense(expense.description);
                categories[category] = (categories[category] || 0) + expense.amount;
            });
            
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedCategories.length === 0) {
                categoriesDiv.innerHTML = '<p style="color: #666; font-style: italic;">No expenses to categorize</p>';
                return;
            }
            
            categoriesDiv.innerHTML = sortedCategories.map(([category, amount]) => `
                <div class="balance-item">
                    <span>${category}</span>
                    <span class="amount-positive">‚Çπ${amount.toFixed(2)}</span>
                </div>
            `).join('');
        }

        function categorizeExpense(description) {
            const desc = description.toLowerCase();
            
            if (desc.includes('food') || desc.includes('meal') || desc.includes('restaurant') || desc.includes('lunch') || desc.includes('dinner') || desc.includes('breakfast')) {
                return 'üçΩÔ∏è Food & Dining';
            } else if (desc.includes('grocery') || desc.includes('market') || desc.includes('vegetables') || desc.includes('fruits')) {
                return 'üõí Groceries';
            } else if (desc.includes('transport') || desc.includes('uber') || desc.includes('taxi') || desc.includes('bus') || desc.includes('metro')) {
                return 'üöó Transportation';
            } else if (desc.includes('electric') || desc.includes('water') || desc.includes('gas') || desc.includes('rent') || desc.includes('utility')) {
                return 'üè† Utilities';
            } else if (desc.includes('medicine') || desc.includes('doctor') || desc.includes('medical') || desc.includes('hospital')) {
                return 'üíä Medical';
            } else if (desc.includes('movie') || desc.includes('game') || desc.includes('entertainment') || desc.includes('party')) {
                return 'üé¨ Entertainment';
            } else {
                return 'üì¶ Others';
            }
        }

        function updateBalancesAndSettlements(context, contextExpenses = null) {
            const expensesToUse = contextExpenses || expenses;
            const totalAmount = expensesToUse.reduce((sum, expense) => sum + expense.amount, 0);
            
            if (members.length === 0 || expensesToUse.length === 0) {
                const balancesDiv = document.getElementById(context === 'dashboard' ? 'dashboardBalances' : 'analyticsSettlements');
                balancesDiv.innerHTML = '<p style="color: #666; font-style: italic;">No data to calculate balances</p>';
                return;
            }
            
            const balances = {};
            const perPersonShare = totalAmount / members.length;
            
            // Initialize balances
            members.forEach(member => {
                balances[member.name] = -perPersonShare;
            });
            
            // Add what each person actually paid
            expensesToUse.forEach(expense => {
                if (balances.hasOwnProperty(expense.paidBy)) {
                    balances[expense.paidBy] += expense.amount;
                }
            });
            
            // Update balances UI
            if (context === 'dashboard') {
                updateDashboardBalances(balances);
                updateDashboardSettlements(balances);
            } else {
                updateAnalyticsSettlements(balances);
            }
        }

        function updateDashboardBalances(balances) {
            const balancesHtml = Object.entries(balances).map(([name, balance]) => {
                const isPositive = balance > 0.01;
                const isNegative = balance < -0.01;
                const className = isPositive ? 'amount-positive' : isNegative ? 'amount-negative' : '';
                const status = isPositive ? 'should receive' : isNegative ? 'owes' : 'settled';
                
                return `
                    <div class="balance-item">
                        <span>${name}</span>
                        <span class="${className}">
                            ${status} ‚Çπ${Math.abs(balance).toFixed(2)}
                        </span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dashboardBalances').innerHTML = balancesHtml;
        }

        function updateDashboardSettlements(balances) {
            const currentSettlements = calculateSettlements(balances);
            const unpaidSettlements = settlements.filter(s => !s.paid);
            
            if (currentSettlements.length === 0) {
                document.getElementById('dashboardSettlements').innerHTML = '<p style="color: #28a745; font-weight: bold;">‚úÖ All settled! No transactions needed.</p>';
            } else {
                const settlementsHtml = unpaidSettlements.map(settlement => `
                    <div class="balance-item">
                        <span>${settlement.from} ‚Üí ${settlement.to}</span>
                        <span style="color: #4facfe; font-weight: bold;">‚Çπ${settlement.amount.toFixed(2)}</span>
                    </div>
                `).join('');
                
                document.getElementById('dashboardSettlements').innerHTML = settlementsHtml || '<p style="color: #28a745; font-weight: bold;">‚úÖ All settlements marked as paid!</p>';
            }
        }

        function updateAnalyticsSettlements(balances) {
            const currentSettlements = calculateSettlements(balances);
            
            if (currentSettlements.length === 0) {
                document.getElementById('analyticsSettlements').innerHTML = '<p style="color: #28a745; font-weight: bold;">‚úÖ All settled for this month!</p>';
            } else {
                const settlementsHtml = currentSettlements.map(settlement => `
                    <div class="balance-item">
                        <span>${settlement.from} ‚Üí ${settlement.to}</span>
                        <span style="color: #4facfe; font-weight: bold;">‚Çπ${settlement.amount.toFixed(2)}</span>
                    </div>
                `).join('');
                
                document.getElementById('analyticsSettlements').innerHTML = settlementsHtml;
            }
        }

        function calculateSettlements(balances) {
            const creditors = [];
            const debtors = [];
            
            Object.entries(balances).forEach(([name, balance]) => {
                if (balance > 0.01) {
                    creditors.push({ name, amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ name, amount: -balance });
                }
            });
            
            const settlementsResult = [];
            let creditorIndex = 0;
            let debtorIndex = 0;
            
            while (creditorIndex < creditors.length && debtorIndex < debtors.length) {
                const creditor = creditors[creditorIndex];
                const debtor = debtors[debtorIndex];
                
                const settlementAmount = Math.min(creditor.amount, debtor.amount);
                
                settlementsResult.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: settlementAmount
                });
                
                creditor.amount -= settlementAmount;
                debtor.amount -= settlementAmount;
                
                if (creditor.amount < 0.01) {
                    creditorIndex++;
                }
                
                if (debtor.amount < 0.01) {
                    debtorIndex++;
                }
            }
            
            return settlementsResult;
        }

        // Event listeners for keyboard shortcuts
        document.getElementById('memberName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addMember();
        });

        document.getElementById('expenseDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addExpense();
        });

        document.getElementById('itemDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addItemToCalculator();
        });

        document.getElementById('itemAmount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addItemToCalculator();
        });

    </script>
</body>
</html>="margin-bottom: 0; min-width: 150px;">
                            <label for="startDate">From Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group" style
